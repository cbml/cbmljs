!function(e,t){if("object"==typeof module&&"object"==typeof module.exports){var n=t(require,exports);void 0!==n&&(module.exports=n)}else"function"==typeof define&&define.amd?define(["require","exports"],t):t(null,e.cbml={})}(this,function(e,t){"use strict";function n(e){return e.replace(/&((quot|lt|gt|amp|nbsp)|#x([a-f\d]+)|#(\d+));/gi,function(e,t,n,o,l){return n?s[n.toLowerCase()]:o?String.fromCharCode(parseInt(o,16)):String.fromCharCode(l)})}function o(e,t){var n=e.slice(0,t).split("\n");return{line:n.length,column:n[n.length-1].length+1}}function l(e,t,n,l){return{source:l?e.slice(t,n):null,start:o(e,t),end:o(e,n)}}function c(e){var t;return Object.keys(u).some(function(n){if(u[n].pattern.indexOf(e)>=0)return t=n,!0}),t}function r(e,t,r){function a(n){t.loc?n.loc=l(e,i,s,t.source):n.loc=null,n.range=[i,s],r(n),i=s}for(var i=0,s=0;i<e.length;){var g=e.slice(i).match(/(<!--|\/\*<|\(\*<|'''<|--\[\[<)(\/?)([\w_]+[\w_-]*[\w_]|[\w_]+)\s*|(<\/)([\w_]+[\w_-]*[\w_]|[\w_]+)(>\*\/|>\*\)|>'''|>\]\]|-->)/);if((s=g?i+g.index:e.length)>i&&a({type:"TextNode",content:e.slice(i,s),loc:null}),!g)break;var d=g[3];if(s+=g[0].length,d){var f=c(g[1]);if("/"!==g[2]){for(var p=[];;){if(!(g=e.slice(s).match(/^\s*([\w_]+[\w_-]*[\w_]|[\w_]+)\s*/)))break;s+=g[0].length;var h={name:g[1],value:"",quoted:""},m="";switch((g=e.slice(s).match(/^\s*=\s*('([^']*)'|"([^"]*)"|([^'"\s\/>]+))\s*/))&&(s+=g[0].length,m=g[1]),m[0]){case'"':case"'":h.quoted=m[0],m=m.slice(1,-1)}h.value=n(m),p.push(h)}var y=u[f].closed2;if(!(g=e.slice(s).match(y))){if("xml"===f){(g=e.slice(s).match(/^[^]*?-->/))?s+=g[0].length:s=e.length,a({type:"TextNode",content:e.slice(i,s),loc:null});continue}if("c"===f&&p.some(function(e){return""===e.quoted&&/^\s*\{/.test(e.value)})){(g=e.slice(s).match(/^[^]*?>\*\//))?s+=g[0].length:s=e.length,a({type:"TextNode",content:e.slice(i,s),loc:null});continue}var b=o(e,s);throw"Uncaught SyntaxError: Can't match "+y+". (line: "+b.line+", col: "+b.column+")"}s+=g[0].length;a(">"===g[1]?{type:"LeftCommentTokenizer",attributes:p,tag:d,language:f,body:[]}:"/"===g[1][0]?{type:"VoidElement",attributes:p,tag:d,language:f}:{type:"LeftBlockTokenizer",attributes:p,tag:d,language:f,body:[]})}else{var v=u[f].closed;if(!(g=e.slice(s).match(v)))throw"Uncaught SyntaxError: Can't match "+v+". (line: "+(b=o(e,s)).line+", col: "+b.column+")";s+=g[0].length,a({type:"RightBlockTokenizer",attributes:null,tag:d,language:f})}}else a({type:"RightCommentTokenizer",attributes:null,tag:d=g[5],language:c(g[6])})}}function a(e,t){if(t&&t.body)for(var n=t.body.length-1;n>=0;n--){var o=t.body[n];if(a(e,o),["LeftBlockTokenizer","LeftCommentTokenizer"].indexOf(o.type)>=0){var l=o,c={type:"TextNode",loc:o.loc,content:e.slice(l.range[0],l.range[1]),range:l.range};o=t.body[n]=c;var r=l.body[0];if(r){l.body[l.body.length-1];o.loc&&(o.loc.end={line:r.loc.start.line,column:r.loc.start.column});var i=[n+1,0];i.push.apply(i,l.body),i.splice.apply(t.body,i)}}var s=t.body[n+1];if(s&&"TextNode"===o.type&&"TextNode"===s.type){var u=o;s.range[0]=u.range[0],s.loc&&(s.loc.start={line:o.loc.start.line,column:o.loc.start.column},s.loc.source&&(s.loc.source=e.slice(s.range[0],s.range[1]))),s.content=e.slice(s.range[0],s.range[1]),t.body.splice(n,1)}}}function i(e){delete e.range,e.body&&e.body.forEach(function(e){i(e)})}Object.defineProperty(t,"__esModule",{value:!0});var s={quot:'"',lt:"<",gt:">",amp:"&",nbsp:"Â "},u={xml:{pattern:["\x3c!--","--\x3e"],closed:/^\s*(\/?-->)/,closed2:/^\s*(\/?-->|>)/},c:{pattern:["/*<",">*/"],closed:/^\s*(\/?>\*\/)/,closed2:/^\s*(\/?>\*\/|>)/},pascal:{pattern:["(*<",">*)"],closed:/^\s*(\/?>\*\))/,closed2:/^\s*(\/?>\*\)|>)/},python:{pattern:["'''<",">'''"],closed:/^\s*(\/?>''')/,closed2:/^\s*(\/?>'''|>)/},lua:{pattern:["--[[<",">]]"],closed:/^\s*(\/?>\]\])/,closed2:/^\s*(\/?>\]\]|>)/}};t.parse=function(e,t){if(null===e||void 0===e)return null;(t=t||{}).loc=void 0===t.loc||t.loc,t.source=void 0===t.source||t.source,t.range=void 0!==t.range&&t.range,e=String(e);var n={language:"cbml",tag:"#cbml",attributes:[],type:"CBMLElement",body:[],loc:t.loc?l(e,0,e.length,t.source):null,range:[0,e.length]};if(!e)return n;var o=[],c=n;return r(e,t,function(t){switch(t.type){case"VoidElement":case"TextNode":c.body.push(t),c.range[1]=t.range[1];break;case"LeftBlockTokenizer":case"LeftCommentTokenizer":c.body.push(t);var l=t;o.push(l),c=l;break;case"RightBlockTokenizer":case"RightCommentTokenizer":for(var r=t,a=o.length-1;;a--){var i=o[a],s=o[a-1];if(!i)throw"No start tag. ("+r.tag+")";if(i.tag==r.tag&&i.language==r.language&&i.type.slice("Left".length)===t.type.slice("Right".length)){"RightBlockTokenizer"===t.type?i.type="BlockElement":i.type="CommentElement",i.range[1]=r.range[1],i.loc&&(i.loc.end={line:r.loc.end.line,column:r.loc.end.column},i.loc.source&&(i.loc.source=e.slice(i.range[0],i.range[1]))),c=s||n,o=o.slice(0,a);break}if(s){var u=i;o[a]={type:"TextNode",content:e.slice(u.range[0],u.range[1]),loc:u.loc,range:u.range}}}}}),a(e,n),t.range||i(n),n}});