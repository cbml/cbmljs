!function(e,t){if("object"==typeof module&&"object"==typeof module.exports){var o=t(require,exports);void 0!==o&&(module.exports=o)}else"function"==typeof define&&define.amd?define(["require","exports"],t):t(null,e.cbml={})}(this,function(e,t){"use strict";function o(e){return e.replace(/&((quot|lt|gt|amp|nbsp)|#x([a-f\d]+)|#(\d+));/gi,function(e,t,o,n,l){return o?i[o.toLowerCase()]:n?String.fromCharCode(parseInt(n,16)):String.fromCharCode(l)})}function n(e,t){var o=e.slice(0,t).split("\n");return{line:o.length,column:o[o.length-1].length+1}}function l(e,t,o,l){return{source:l?null:e.slice(t,o),start:n(e,t),end:n(e,o)}}function s(e){var t;return Object.keys(u).some(function(o){if(u[o].pattern.indexOf(e)>=0)return t=o,!0}),t}function c(e,t,c){function r(o){t.ignoreLocation?o.loc=null:o.loc=l(e,a,i,t.ignoreSource),o.startPos=a,o.endPos=i,c(o),a=i}for(var a=0,i=0;a<e.length;){var d=e.slice(a).match(/(<!--|\/\*<|\(\*<|'''<|--\[\[<)(\/?)([\w_]+[\w_-]*[\w_]|[\w_]+)\s*|(<\/)([\w_]+[\w_-]*[\w_]|[\w_]+)(>\*\/|>\*\)|>'''|>\]\]|-->)/);if((i=d?a+d.index:e.length)>a&&r({type:"TextNode",content:e.slice(a,i),loc:null}),!d)break;var g=d[3];if(i+=d[0].length,g){var f=s(d[1]);if("/"!==d[2]){for(var p=[];;){if(!(d=e.slice(i).match(/^\s*([\w_]+[\w_-]*[\w_]|[\w_]+)\s*/)))break;i+=d[0].length;var h={name:d[1],value:"",quoted:""},m="";switch((d=e.slice(i).match(/^\s*=\s*('([^']*)'|"([^"]*)"|([^'"\s\/>]+))\s*/))&&(i+=d[0].length,m=d[1]),m[0]){case'"':case"'":h.quoted=m[0],m=m.slice(1,-1)}h.value=o(m),p.push(h)}var y=u[f].closed2;if(!(d=e.slice(i).match(y))){if("xml"===f){(d=e.slice(i).match(/^[^]*?-->/))?i+=d[0].length:i=e.length,r({type:"TextNode",content:e.slice(a,i),loc:null});continue}if("c"===f&&p.some(function(e){return""===e.quoted&&/^\s*\{/.test(e.value)})){(d=e.slice(i).match(/^[^]*?>\*\//))?i+=d[0].length:i=e.length,r({type:"TextNode",content:e.slice(a,i),loc:null});continue}var b=n(e,i);throw"Uncaught SyntaxError: Can't match "+y+". (line: "+b.line+", col: "+b.column+")"}i+=d[0].length;r(">"===d[1]?{type:"LeftCommentTokenizer",attributes:p,tag:g,language:f,body:[]}:"/"===d[1][0]?{type:"VoidElement",attributes:p,tag:g,language:f}:{type:"LeftBlockTokenizer",attributes:p,tag:g,language:f,body:[]})}else{var v=u[f].closed;if(!(d=e.slice(i).match(v)))throw"Uncaught SyntaxError: Can't match "+v+". (line: "+(b=n(e,i)).line+", col: "+b.column+")";i+=d[0].length,r({type:"RightBlockTokenizer",attributes:null,tag:g,language:f})}}else r({type:"RightCommentTokenizer",attributes:null,tag:g=d[5],language:s(d[6])})}}function r(e,t){if(t&&t.body)for(var o=t.body.length-1;o>=0;o--){var n=t.body[o];if(r(e,n),["LeftBlockTokenizer","LeftCommentTokenizer"].indexOf(n.type)>=0){var l=n,s={type:"TextNode",loc:n.loc,content:e.slice(l.startPos,l.endPos),startPos:l.startPos,endPos:l.endPos};n=t.body[o]=s;var c=l.body[0];if(c){l.body[l.body.length-1];n.loc&&(n.loc.end={line:c.loc.start.line,column:c.loc.start.column});var a=[o+1,0];a.push.apply(a,l.body),a.splice.apply(t.body,a)}}var i=t.body[o+1];if(i&&"TextNode"===n.type&&"TextNode"===i.type){var u=n;i.startPos=u.startPos,i.loc&&(i.loc.start={line:n.loc.start.line,column:n.loc.start.column},i.loc.source&&(i.loc.source=e.slice(i.startPos,i.endPos))),i.content=e.slice(i.startPos,i.endPos),t.body.splice(o,1)}}}function a(e){delete e.startPos,delete e.endPos,e.body&&e.body.forEach(function(e){a(e)})}Object.defineProperty(t,"__esModule",{value:!0});var i={quot:'"',lt:"<",gt:">",amp:"&",nbsp:"Â "},u={xml:{pattern:["\x3c!--","--\x3e"],closed:/^\s*(\/?-->)/,closed2:/^\s*(\/?-->|>)/},c:{pattern:["/*<",">*/"],closed:/^\s*(\/?>\*\/)/,closed2:/^\s*(\/?>\*\/|>)/},pascal:{pattern:["(*<",">*)"],closed:/^\s*(\/?>\*\))/,closed2:/^\s*(\/?>\*\)|>)/},python:{pattern:["'''<",">'''"],closed:/^\s*(\/?>''')/,closed2:/^\s*(\/?>'''|>)/},lua:{pattern:["--[[<",">]]"],closed:/^\s*(\/?>\]\])/,closed2:/^\s*(\/?>\]\]|>)/}};t.parse=function(e,t){if(null===e||void 0===e)return null;t=t||{},e=String(e);var o={language:"cbml",tag:"#cbml",attributes:[],type:"CBMLElement",body:[],loc:t.ignoreLocation?null:l(e,0,e.length,t.ignoreSource)};if(!e)return o;var n=[],s=o;return c(e,t,function(t){switch(t.type){case"VoidElement":case"TextNode":s.body.push(t),s.endPos=t.endPos;break;case"LeftBlockTokenizer":case"LeftCommentTokenizer":s.body.push(t);var l=t;n.push(l),s=l;break;case"RightBlockTokenizer":case"RightCommentTokenizer":for(var c=t,r=n.length-1;;r--){var a=n[r],i=n[r-1];if(!a)throw"No start tag. ("+c.tag+")";if(a.tag==c.tag&&a.language==c.language&&a.type.slice("Left".length)===t.type.slice("Right".length)){"RightBlockTokenizer"===t.type?a.type="BlockElement":a.type="CommentElement",a.endPos=c.endPos,a.loc&&(a.loc.end={line:c.loc.end.line,column:c.loc.end.column},a.loc.source&&(a.loc.source=e.slice(a.startPos,a.endPos))),s=i||o,n=n.slice(0,r);break}if(i){var u=a;n[r]={type:"TextNode",content:e.slice(u.startPos,u.endPos),loc:u.loc,startPos:u.startPos,endPos:u.endPos}}}}}),r(e,o),a(o),o}});