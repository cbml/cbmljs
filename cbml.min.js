!function(e){function t(e){return String(e).replace(/&((quot|lt|gt|amp|nbsp)|#x([a-f\d]+)|#(\d+));/gi,function(e,t,n,s,o){return n?p[n.toLowerCase()]:String.fromCharCode(s?parseInt(s,16):+o)})}function n(e,t){for(var n=e.length.toString().length,s=e.slice(-t),o=s.length-1;o>=0;o--){var a=(e.length+o-s.length+1).toString();a=new Array(n-a.length+1).join(" ")+a,s[o]=a+(o===s.length-1?" > ":"   ")+"| "+s[o]}console.log(s.join("\n"))}function s(e,s){function o(t,n,o,r){if(!(n>=o)){var p=e.slice(n,o),c={type:t,pos:n,endpos:o,value:p};r=r||{};for(var i in r)c[i]=r[i];if(!s.ignoreLine){var g=e.slice(0,n).split("\n");c.line=g.length,c.col=g[g.length-1].length+1,g=null}l.pos=o,a.push(c)}}s=s||{};for(var a=[],l={text:e,pos:0};l.pos<l.text.length;){var r=l.text.substring(l.pos).match(/(<!--|\/\*<|\(\*<|'''<|--\[\[<)(\/?)([\w_]+[\w_-]*[\w_]|[\w_]+)\s*|(<\/)([\w_]+[\w_-]*[\w_]|[\w_]+)(>\*\/|>\*\)|>'''|>\]\]|-->)/);if(!r)break;o("text",l.pos,l.pos+r.index);var p,c,i=r[3],g={},u=r[0].length;if(i){switch(r[1]){case"<!--":c=/^\s*(\/?-->)/,p="xml";break;case"/*<":c=/^\s*(\/?>\*\/)/,p="c";break;case"(*<":c=/^\s*(\/?>\*\))/,p="pascal";break;case"'''<":c=/^\s*(\/?>''')/,p="python";break;case"--[[<":c=/^\s*(\/?>\]\])/,p="lua"}var h,d,f,v;if("/"===r[2]){if(r=l.text.substring(l.pos+u).match(c),!r)throw h=e.slice(0,l.pos+u).split("\n"),d=h.length,f=h[h.length-1].length+1,n(h,5),v="Uncaught SyntaxError: Can't match \""+c+'". (line:'+d+" col:"+f+")",console.error(v),v;u+=r[0].length,o("right",l.pos,l.pos+u,{tag:i,language:p})}else{for(;;){if(r=l.text.substring(l.pos+u).match(/^\s*([\w_]+[\w_-]*[\w_]|[\w_]+)\s*/),!r)break;u+=r[0].length;var m=r[1],x="";switch(r=l.text.substring(l.pos+u).match(/^\s*=\s*('([^']*)'|"([^"]*)"|([^'"\s\/>]+))\s*/),r&&(u+=r[0].length,x=r[1]),x[0]){case'"':case"'":x=x.slice(1,-1)}g[m]=t(x)}switch(p){case"xml":c=/^\s*(\/?-->|>)/;break;case"c":c=/^\s*(\/?>\*\/|>)/;break;case"pascal":c=/^\s*(\/?>\*\)|>)/;break;case"python":c=/^\s*(\/?>'''|>)/;break;case"lua":c=/^\s*(\/?>\]\]|>)/}if(r=l.text.substring(l.pos+u).match(c),!r){if("xml"===p){r=l.text.substring(l.pos+u).match(/^[^]*?-->/),r?(u+=r[0].length,o("text",l.pos,l.pos+u)):(u=l.text.length,o("text",l.pos,u));continue}throw h=e.slice(0,l.pos+u).split("\n"),d=h.length,f=h[h.length-1].length+1,n(h,5),v="Uncaught SyntaxError: Can't match \""+c+'". (line:'+d+" col:"+f+")",console.error(v),v}u+=r[0].length,">"===r[1]?o("left",l.pos,l.pos+u,{comment:!0,tag:i,language:p,attrs:g}):o("/"===r[1][0]?"single":"left",l.pos,l.pos+u,{tag:i,language:p,attrs:g})}}else{switch(i=r[5],r[6]){case"-->":p="xml";break;case">*/":p="c";break;case">*)":p="pascal";break;case">'''":p="python";break;case">]]":p="lua"}o("right",l.pos,l.pos+u,{comment:!0,tag:i,language:p})}}return o("text",l.pos,l.text.length),a}function o(e){var t="";return e&&e.forEach(function(e){return t+=e.value}),t}function a(e,t){if(!e)return{type:"cbml",nodes:[],value:""};e=String(e).replace(/\r\n?|[\n\u2028\u2029]/g,"\n").replace(/^\uFEFF/,"");var a={type:"cbml",nodes:[]},r=a,p=s(e,t),c=[];return p.forEach(function(t){switch(t.type){case"single":case"text":r.nodes.push(t),a!==r&&(r.value+=t.value),r.endpos=t.endpos;break;case"left":t.nodes=[],c.push(t),r.nodes.push(t),r=t;break;case"right":var s,l,p,i;if(c.length<=0)throw s=e.slice(0,t.endpos).split("\n"),l=s.length,p=s[s.length-1].length+1,n(s,5),i="No start tag. (line:"+t.line+" col:"+t.col+")",console.error(i),i;for(var g=c.length-1;g>=0;g--){var u=c[g],h=c[g-1];if(u.tag===t.tag&&u.language===t.language&&u.comment===t.comment){if(u.type="block",u.value+=t.value,u.endpos=t.endpos,u.content=o(u.nodes),h?(r=h,r.value+=u.value):r=a,r.endpos=u.endpos,u.nodes&&u.nodes.length){var d=u.nodes[0],f=u.nodes[u.nodes.length-1];u.prefix=u.value.slice(0,d.pos-u.pos),u.suffix=u.value.slice(-(u.endpos-f.endpos))}c=c.slice(0,g);break}if(!h)throw s=e.slice(0,t.endpos).split("\n"),l=s.length,p=s[s.length-1].length+1,n(s,5),i="No start tag. (line:"+t.line+" col:"+t.col+")",console.error(i),i;u.type="text",delete u.nodes,delete u.tag,delete u.attrs,delete u.language,h.value+=u.value,h.endpos=u.endpos}}}),l(e,a),a}function l(e,t){if(t&&t.nodes)for(var n=t.nodes.length-1;n>=0;n--){var s=t.nodes[n];if(l(e,s),"left"===s.type){s.type="text";var o=s.nodes[0];if(o){var a=s.nodes[s.nodes.length-1];s.endpos=o.pos,s.value=e.slice(s.pos,s.endpos);var r=[n+1,0];[].push.apply(r,s.nodes),[].splice.apply(t.nodes,r),"cbml"!==t.type&&(t.endpos=a.endpos,t.value=e.slice(t.pos,t.endpos))}delete s.nodes,delete s.tag,delete s.attrs,delete s.language}var p=t.nodes[n+1];p&&"text"===s.type&&"text"===p.type&&(p.pos=s.pos,p.value=e.slice(p.pos,p.endpos),t.nodes.splice(n,1))}}var r=r||{},p={quot:'"',lt:"<",gt:">",amp:"&",nbsp:" "};r.tokenizer=s,r.parse=a,"function"==typeof define?define.amd&&define(function(){return r}):"undefined"!=typeof module&&module.exports?module.exports=r:window[e]=r}("cbml");