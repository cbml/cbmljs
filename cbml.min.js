!function(e){"use strict";function t(e){return String(e).replace(/&((quot|lt|gt|amp|nbsp)|#x([a-f\d]+)|#(\d+));/gi,function(e,t,n,s,a){return n?r[n.toLowerCase()]:String.fromCharCode(s?parseInt(s,16):parseInt(a,10))})}function n(e,t){for(var n=e.length.toString().length,s=e.slice(-(t||5)),a=s.length-1;a>=0;a--){var o=(e.length+a-s.length+1).toString();o=new Array(n-o.length+1).join(" ")+o,s[a]=o+(a===s.length-1?" > ":"   ")+"| "+s[a]}console.log(s.join("\n"))}function s(e,s){function a(t,n,a,r){if(!(n>=a)){var c=e.slice(n,a),i={type:t,pos:n,endpos:a,value:c};r=r||{};for(var g in r)i[g]=r[g];if(!s.ignoreLine){var p=e.slice(0,n).split("\n");i.line=p.length,i.col=p[p.length-1].length+1,p=null}l.pos=a,o.push(i)}}s=s||{};for(var o=[],l={text:e,pos:0};l.pos<l.text.length;){var r=l.text.substring(l.pos).match(/(<!--|\/\*<|\(\*<|'''<|--\[\[<)(\/?)([\w_]+[\w_-]*[\w_]|[\w_]+)\s*|(<\/)([\w_]+[\w_-]*[\w_]|[\w_]+)(>\*\/|>\*\)|>'''|>\]\]|-->)/);if(!r)break;a("text",l.pos,l.pos+r.index);var c,i,g=r[3],p={},u=r[0].length;if(g){switch(r[1]){case"<!--":i=/^\s*(\/?-->)/,c="xml";break;case"/*<":i=/^\s*(\/?>\*\/)/,c="c";break;case"(*<":i=/^\s*(\/?>\*\))/,c="pascal";break;case"'''<":i=/^\s*(\/?>''')/,c="python";break;case"--[[<":i=/^\s*(\/?>\]\])/,c="lua"}var h,d,f,v;if("/"===r[2]){if(r=l.text.substring(l.pos+u).match(i),!r)throw h=e.slice(0,l.pos+u).split("\n"),d=h.length,f=h[h.length-1].length+1,n(h,5),v="Uncaught SyntaxError: Can't match \""+i+'". (line:'+d+" col:"+f+")",console.error(v),v;u+=r[0].length,a("right",l.pos,l.pos+u,{tag:g,language:c})}else{for(;;){if(r=l.text.substring(l.pos+u).match(/^\s*([\w_]+[\w_-]*[\w_]|[\w_]+)\s*/),!r)break;u+=r[0].length;var m=r[1],b="";switch(r=l.text.substring(l.pos+u).match(/^\s*=\s*('([^']*)'|"([^"]*)"|([^'"\s\/>]+))\s*/),r&&(u+=r[0].length,b=r[1]),b[0]){case'"':case"'":b=b.slice(1,-1)}p[m]=t(b)}switch(c){case"xml":i=/^\s*(\/?-->|>)/;break;case"c":i=/^\s*(\/?>\*\/|>)/;break;case"pascal":i=/^\s*(\/?>\*\)|>)/;break;case"python":i=/^\s*(\/?>'''|>)/;break;case"lua":i=/^\s*(\/?>\]\]|>)/}if(r=l.text.substring(l.pos+u).match(i),!r)throw h=e.slice(0,l.pos+u).split("\n"),d=h.length,f=h[h.length-1].length+1,n(h,5),v="Uncaught SyntaxError: Can't match \""+i+'". (line:'+d+" col:"+f+")",console.error(v),v;u+=r[0].length,">"===r[1]?a("left",l.pos,l.pos+u,{comment:!0,tag:g,language:c,attrs:p}):a("/"===r[1][0]?"single":"left",l.pos,l.pos+u,{tag:g,language:c,attrs:p})}}else{switch(g=r[5],r[6]){case"-->":c="xml";break;case">*/":c="c";break;case">*)":c="pascal";break;case">'''":c="python";break;case">]]":c="lua"}a("right",l.pos,l.pos+u,{comment:!0,tag:g,language:c})}}return a("text",l.pos,l.text.length),o}function a(e){var t="";return e&&e.forEach(function(e){return t+=e.value}),t}function o(e,t){if(e){e=String(e).replace(/\r\n?|[\n\u2028\u2029]/g,"\n").replace(/^\uFEFF/,"");var o={type:"cbml",nodes:[]},l=o,r=s(e,t),c=[];r.forEach(function(t){switch(t.type){case"single":case"text":l.nodes.push(t),o!==l&&(l.value+=t.value),l.endpos=t.endpos;break;case"left":t.nodes=[],c.push(t),l.nodes.push(t),l=t;break;case"right":var s,r,i,g;if(c.length<=0)throw s=e.slice(0,t.endpos).split("\n"),r=s.length,i=s[s.length-1].length+1,n(s,5),g="No start tag. (line:"+t.line+" col:"+t.col+")",console.error(g),g;for(var p=c.length-1;p>=0;p--){var u=c[p],h=c[p-1];if(u.tag===t.tag&&u.language===t.language&&u.comment===t.comment){if(u.type="block",u.value+=t.value,u.endpos=t.endpos,u.content=a(u.nodes),h?(l=h,l.value+=u.value):l=o,l.endpos=u.endpos,u.nodes&&u.nodes.length){var d=u.nodes[0],f=u.nodes[u.nodes.length-1];u.prefix=u.value.slice(0,d.pos-u.pos),u.suffix=u.value.slice(-(u.endpos-f.endpos))}c=c.slice(0,p);break}if(!h)throw s=e.slice(0,t.endpos).split("\n"),r=s.length,i=s[s.length-1].length+1,n(s,5),g="No start tag. (line:"+t.line+" col:"+t.col+")",console.error(g),g;u.type="text",delete u.nodes,delete u.tag,delete u.attrs,delete u.language,h.value+=u.value,h.endpos=u.endpos}}});for(var i=c.length-1;i>=0;i--){var g=c[i];g.type="text",delete g.nodes,delete g.tag,delete g.attrs,delete g.language;var p=c[i-1];p?p.value+=g.value:p=o,p.endpos=g.endpos}return o}}var l=l||{},r={quot:'"',lt:"<",gt:">",amp:"&",nbsp:" "};l.tokenizer=s,l.parse=o,"function"==typeof define?(define.amd||define.cmd)&&define(function(){return l}):"undefined"!=typeof module&&module.exports?module.exports=l:window[e]=l}("cbml");