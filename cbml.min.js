!function(e){"use strict";function t(e){return String(e).replace(/&((quot|lt|gt|amp|nbsp)|#x([a-f\d]+)|#(\d+));/gi,function(e,t,s,a,n){return s?o[s.toLowerCase()]:String.fromCharCode(a?parseInt(a,16):parseInt(n,10))})}function s(e,s){function a(t,a,o,l){if(!(a>=o)){var p=e.slice(a,o),c={type:t,pos:a,endpos:o,value:p};l=l||{};for(var i in l)c[i]=l[i];if(!s.ignoreLine){var u=e.slice(0,a).split("\n");c.line=u.length,c.col=u[u.length-1].length+1,u=null}r.pos=o,n.push(c)}}e=String(e).replace(/\r\n?|[\n\u2028\u2029]/g,"\n").replace(/^\uFEFF/,""),s=s||{};for(var n=[],r={text:e,pos:0};r.pos<r.text.length;){var o=r.text.substring(r.pos).match(/(<!--|\/\*<|\(\*<|'''<|--\[\[<)(\/?)([\w_-]+)\s*|(<\/)([\w_-]+)(>\*\/|>\*\)|>'''|>\]\]|-->)/);if(!o)break;a("text",r.pos,r.pos+o.index);var l,p,c=o[3],i={},u=o[0].length;if(c){switch(o[1]){case"<!--":p=/^\s*(\/?-->)/,l="xml";break;case"/*<":p=/^\s*(\/?>\*\/)/,l="c";break;case"(*<":p=/^\s*(\/?>\*\))/,l="pascal";break;case"'''<":p=/^\s*(\/?>''')/,l="python";break;case"--[[<":p=/^\s*(\/?>\]\])/,l="lua"}if("/"===o[2]){if(o=r.text.substring(r.pos+u).match(p),!o)throw new Error("parse error.");u+=o[0].length,a("right",r.pos,r.pos+u,{tag:c,language:l})}else{for(;;){if(o=r.text.substring(r.pos+u).match(/^\s*([\w_-]+)\s*/),!o)break;u+=o[0].length;var g=o[1],d="";switch(o=r.text.substring(r.pos+u).match(/^\s*=\s*('([^']*)'|"([^"]*)"|([^'"\s\/>]+))\s*/),o&&(u+=o[0].length,d=o[1]),d[0]){case'"':case"'":d=d.slice(1,-1)}i[g]=t(d)}switch(l){case"xml":p=/^\s*(\/?-->|>)/;break;case"c":p=/^\s*(\/?>\*\/|>)/;break;case"pascal":p=/^\s*(\/?>\*\)|>)/;break;case"python":p=/^\s*(\/?>'''|>)/;break;case"lua":p=/^\s*(\/?>\]\]|>)/}if(o=r.text.substring(r.pos+u).match(p),!o){var f=e.slice(0,r.pos+u).split("\n"),h=f.length,v=f[f.length-1].length+1;throw"parse error. (line:"+h+" col:"+v+")"}u+=o[0].length,">"===o[1]?a("commentLeft",r.pos,r.pos+u,{tag:c,language:l,attrs:i}):a("/"===o[1][0]?"single":"left",r.pos,r.pos+u,{tag:c,language:l,attrs:i})}}else{switch(c=o[5],o[6]){case"-->":l="xml";break;case">*/":l="c";break;case">*)":l="pascal";break;case">'''":l="python";break;case">]]":l="lua"}a("commentRight",r.pos,r.pos+u,{tag:c,language:l})}}return a("text",r.pos,r.text.length),n}function a(e){var t="";return e&&e.forEach(function(e){return t+=e.value}),t}function n(e,t){if(e){e=String(e);var n={type:"cbml",nodes:[]},r=n,o=s(e,t),l=[],p=[],c=[];o.forEach(function(e){switch(e.type){case"single":case"text":r.nodes.push(e),n!==r&&(r.value+=e.value),r.endpos=e.endpos;break;case"commentLeft":case"left":c="left"===e.type?l:p,e.nodes=[],c.push(e),r.nodes.push(e),r=e;break;case"commentRight":case"right":c="right"===e.type?l:p;for(var t=c.length-1;t>=0;t--){var s=c[t],o=c[t-1];if(s.tag===e.tag&&s.language===e.language){if(s.type="block",s.value+=e.value,s.endpos=e.endpos,s.content=a(s.nodes),o?(r=o,r.value+=s.value):r=n,r.endpos=s.endpos,s.nodes&&s.nodes.length){var i=s.nodes[0],u=s.nodes[s.nodes.length-1];s.prefix=s.value.slice(0,i.pos-s.pos),s.suffix=s.value.slice(-(s.endpos-u.endpos))}c=c.slice(0,t);break}if(!o)throw new Error("parse error.");s.type="text",delete s.nodes,delete s.tag,delete s.attrs,delete s.language,o.value+=s.value,o.endpos=s.endpos}"right"===e.type?l=c:p=c}});for(var i=l.length-1;i>=0;i--){var u=l[i];u.type="text",delete u.nodes,delete u.tag,delete u.attrs,delete u.language;var g=l[i-1];g?g.value+=u.value:g=n,g.endpos=u.endpos}return n}}var r=r||{},o={quot:'"',lt:"<",gt:">",amp:"&",nbsp:" "};r.tokenizer=s,r.parse=n,"function"==typeof define?(define.amd||define.cmd)&&define(function(){return r}):"undefined"!=typeof module&&module.exports?module.exports=r:window[e]=r}("cbml");