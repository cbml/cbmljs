!function(e){function t(e){return String(e).replace(/&((quot|lt|gt|amp|nbsp)|#x([a-f\d]+)|#(\d+));/gi,function(e,t,n,s,o){return n?c[n.toLowerCase()]:String.fromCharCode(s?parseInt(s,16):+o)})}function n(e,t){for(var n=e.length.toString().length,s=e.slice(-t),o=s.length-1;o>=0;o--){var a=(e.length+o-s.length+1).toString();a=new Array(n-a.length+1).join(" ")+a,s[o]=a+(o===s.length-1?" > ":"   ")+"| "+s[o]}console.log(s.join("\n"))}function s(e,s){function o(t,n,o,r){if(!(n>=o)){var c=e.slice(n,o),p={type:t,pos:n,endpos:o,value:c};r=r||{};for(var i in r)p[i]=r[i];if(!s.ignoreLine){var g=e.slice(0,n).split("\n");p.line=g.length,p.col=g[g.length-1].length+1,g=null}l.pos=o,a.push(p)}}s=s||{};for(var a=[],l={text:e,pos:0};l.pos<l.text.length;){var r=l.text.substring(l.pos).match(/(<!--|\/\*<|\(\*<|'''<|--\[\[<)(\/?)([\w_]+[\w_-]*[\w_]|[\w_]+)\s*|(<\/)([\w_]+[\w_-]*[\w_]|[\w_]+)(>\*\/|>\*\)|>'''|>\]\]|-->)/);if(!r)break;o("text",l.pos,l.pos+r.index);var c,p,i=r[3],g={},u={},h=r[0].length;if(i){switch(r[1]){case"<!--":p=/^\s*(\/?-->)/,c="xml";break;case"/*<":p=/^\s*(\/?>\*\/)/,c="c";break;case"(*<":p=/^\s*(\/?>\*\))/,c="pascal";break;case"'''<":p=/^\s*(\/?>''')/,c="python";break;case"--[[<":p=/^\s*(\/?>\]\])/,c="lua"}var d,f,v,x;if("/"===r[2]){if(r=l.text.substring(l.pos+h).match(p),!r)throw d=e.slice(0,l.pos+h).split("\n"),f=d.length,v=d[d.length-1].length+1,n(d,5),x="Uncaught SyntaxError: Can't match \""+p+'". (line:'+f+" col:"+v+")",console.error(x),x;h+=r[0].length,o("right",l.pos,l.pos+h,{tag:i,language:c})}else{for(;;){if(r=l.text.substring(l.pos+h).match(/^\s*([\w_]+[\w_-]*[\w_]|[\w_]+)\s*/),!r)break;h+=r[0].length;var m=r[1],b="";switch(r=l.text.substring(l.pos+h).match(/^\s*=\s*('([^']*)'|"([^"]*)"|([^'"\s\/>]+))\s*/),r&&(h+=r[0].length,b=r[1]),b[0]){case'"':case"'":b=b.slice(1,-1),u[m]=b[0]}g[m]=t(b)}switch(c){case"xml":p=/^\s*(\/?-->|>)/;break;case"c":p=/^\s*(\/?>\*\/|>)/;break;case"pascal":p=/^\s*(\/?>\*\)|>)/;break;case"python":p=/^\s*(\/?>'''|>)/;break;case"lua":p=/^\s*(\/?>\]\]|>)/}if(r=l.text.substring(l.pos+h).match(p),!r){if("xml"===c){r=l.text.substring(l.pos+h).match(/^[^]*?-->/),r?(h+=r[0].length,o("text",l.pos,l.pos+h)):(h=l.text.length,o("text",l.pos,h));continue}if("c"===c){var w;if(Object.keys(g).some(function(e){return!u[e]&&/^\s*\{/.test(g[e])?(w=!0,!0):void 0}),w){r=l.text.substring(l.pos+h).match(/^[^]*?>\*\//),r?(h+=r[0].length,o("text",l.pos,l.pos+h)):(h=l.text.length,o("text",l.pos,h));continue}}throw d=e.slice(0,l.pos+h).split("\n"),f=d.length,v=d[d.length-1].length+1,n(d,5),x="Uncaught SyntaxError: Can't match \""+p+'". (line:'+f+" col:"+v+")",console.error(x),x}h+=r[0].length,">"===r[1]?o("left",l.pos,l.pos+h,{comment:!0,tag:i,language:c,attrs:g}):o("/"===r[1][0]?"single":"left",l.pos,l.pos+h,{tag:i,language:c,attrs:g})}}else{switch(i=r[5],r[6]){case"-->":c="xml";break;case">*/":c="c";break;case">*)":c="pascal";break;case">'''":c="python";break;case">]]":c="lua"}o("right",l.pos,l.pos+h,{comment:!0,tag:i,language:c})}}return o("text",l.pos,l.text.length),a}function o(e){var t="";return e&&e.forEach(function(e){return t+=e.value}),t}function a(e,t){if(t&&t.nodes)for(var n=t.nodes.length-1;n>=0;n--){var s=t.nodes[n];if(a(e,s),"left"===s.type){s.type="text";var o=s.nodes[0];if(o){var l=s.nodes[s.nodes.length-1];s.endpos=o.pos,s.value=e.slice(s.pos,s.endpos);var r=[n+1,0];[].push.apply(r,s.nodes),[].splice.apply(t.nodes,r),"cbml"!==t.type&&(t.endpos=l.endpos,t.value=e.slice(t.pos,t.endpos))}delete s.nodes,delete s.tag,delete s.attrs,delete s.language}var c=t.nodes[n+1];c&&"text"===s.type&&"text"===c.type&&(c.pos=s.pos,c.value=e.slice(c.pos,c.endpos),t.nodes.splice(n,1))}}function l(e,t){if(!e)return{type:"cbml",nodes:[],value:""};e=String(e).replace(/\r\n?|[\n\u2028\u2029]/g,"\n").replace(/^\uFEFF/,"");var l={type:"cbml",nodes:[]},r=l,c=s(e,t),p=[];return c.forEach(function(t){switch(t.type){case"single":case"text":r.nodes.push(t),l!==r&&(r.value+=t.value),r.endpos=t.endpos;break;case"left":t.nodes=[],p.push(t),r.nodes.push(t),r=t;break;case"right":var s,a,c,i;if(p.length<=0)throw s=e.slice(0,t.endpos).split("\n"),a=s.length,c=s[s.length-1].length+1,n(s,5),i="No start tag. (line:"+t.line+" col:"+t.col+")",console.error(i),i;for(var g=p.length-1;g>=0;g--){var u=p[g],h=p[g-1];if(u.tag===t.tag&&u.language===t.language&&u.comment===t.comment){if(u.type="block",u.value+=t.value,u.endpos=t.endpos,u.content=o(u.nodes),h?(r=h,r.value+=u.value):r=l,r.endpos=u.endpos,u.nodes&&u.nodes.length){var d=u.nodes[0],f=u.nodes[u.nodes.length-1];u.prefix=u.value.slice(0,d.pos-u.pos),u.suffix=u.value.slice(-(u.endpos-f.endpos))}p=p.slice(0,g);break}if(!h)throw s=e.slice(0,t.endpos).split("\n"),a=s.length,c=s[s.length-1].length+1,n(s,5),i="No start tag. (line:"+t.line+" col:"+t.col+")",console.error(i),i;u.type="text",delete u.nodes,delete u.tag,delete u.attrs,delete u.language,h.value+=u.value,h.endpos=u.endpos}}}),a(e,l),l}var r=r||{},c={quot:'"',lt:"<",gt:">",amp:"&",nbsp:" "};r.tokenizer=s,r.parse=l,"function"==typeof define?define.amd&&define(function(){return r}):"undefined"!=typeof module&&module.exports?module.exports=r:window[e]=r}("cbml");