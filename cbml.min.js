!function(e){function t(e){return String(e).replace(/&((quot|lt|gt|amp|nbsp)|#x([a-f\d]+)|#(\d+));/gi,function(e,t,n,s,a){return n?r[n.toLowerCase()]:String.fromCharCode(s?parseInt(s,16):parseInt(a,10))})}function n(e,t){for(var n=e.length.toString().length,s=e.slice(-t),a=s.length-1;a>=0;a--){var l=(e.length+a-s.length+1).toString();l=new Array(n-l.length+1).join(" ")+l,s[a]=l+(a===s.length-1?" > ":"   ")+"| "+s[a]}console.log(s.join("\n"))}function s(e,s){function a(t,n,a,r){if(!(n>=a)){var c=e.slice(n,a),g={type:t,pos:n,endpos:a,value:c};r=r||{};for(var i in r)g[i]=r[i];if(!s.ignoreLine){var p=e.slice(0,n).split("\n");g.line=p.length,g.col=p[p.length-1].length+1,p=null}o.pos=a,l.push(g)}}s=s||{};for(var l=[],o={text:e,pos:0};o.pos<o.text.length;){var r=o.text.substring(o.pos).match(/(<!--|\/\*<|\(\*<|'''<|--\[\[<)(\/?)([\w_]+[\w_-]*[\w_]|[\w_]+)\s*|(<\/)([\w_]+[\w_-]*[\w_]|[\w_]+)(>\*\/|>\*\)|>'''|>\]\]|-->)/);if(!r)break;a("text",o.pos,o.pos+r.index);var c,g,i=r[3],p={},u=r[0].length;if(i){switch(r[1]){case"<!--":g=/^\s*(\/?-->)/,c="xml";break;case"/*<":g=/^\s*(\/?>\*\/)/,c="c";break;case"(*<":g=/^\s*(\/?>\*\))/,c="pascal";break;case"'''<":g=/^\s*(\/?>''')/,c="python";break;case"--[[<":g=/^\s*(\/?>\]\])/,c="lua"}var h,d,f,v;if("/"===r[2]){if(r=o.text.substring(o.pos+u).match(g),!r)throw h=e.slice(0,o.pos+u).split("\n"),d=h.length,f=h[h.length-1].length+1,n(h,5),v="Uncaught SyntaxError: Can't match \""+g+'". (line:'+d+" col:"+f+")",console.error(v),v;u+=r[0].length,a("right",o.pos,o.pos+u,{tag:i,language:c})}else{for(;;){if(r=o.text.substring(o.pos+u).match(/^\s*([\w_]+[\w_-]*[\w_]|[\w_]+)\s*/),!r)break;u+=r[0].length;var b=r[1],m="";switch(r=o.text.substring(o.pos+u).match(/^\s*=\s*('([^']*)'|"([^"]*)"|([^'"\s\/>]+))\s*/),r&&(u+=r[0].length,m=r[1]),m[0]){case'"':case"'":m=m.slice(1,-1)}p[b]=t(m)}switch(c){case"xml":g=/^\s*(\/?-->|>)/;break;case"c":g=/^\s*(\/?>\*\/|>)/;break;case"pascal":g=/^\s*(\/?>\*\)|>)/;break;case"python":g=/^\s*(\/?>'''|>)/;break;case"lua":g=/^\s*(\/?>\]\]|>)/}if(r=o.text.substring(o.pos+u).match(g),!r)throw h=e.slice(0,o.pos+u).split("\n"),d=h.length,f=h[h.length-1].length+1,n(h,5),v="Uncaught SyntaxError: Can't match \""+g+'". (line:'+d+" col:"+f+")",console.error(v),v;u+=r[0].length,">"===r[1]?a("left",o.pos,o.pos+u,{comment:!0,tag:i,language:c,attrs:p}):a("/"===r[1][0]?"single":"left",o.pos,o.pos+u,{tag:i,language:c,attrs:p})}}else{switch(i=r[5],r[6]){case"-->":c="xml";break;case">*/":c="c";break;case">*)":c="pascal";break;case">'''":c="python";break;case">]]":c="lua"}a("right",o.pos,o.pos+u,{comment:!0,tag:i,language:c})}}return a("text",o.pos,o.text.length),l}function a(e){var t="";return e&&e.forEach(function(e){return t+=e.value}),t}function l(e,t){if(!e)return{type:"cbml",nodes:[],value:""};e=String(e).replace(/\r\n?|[\n\u2028\u2029]/g,"\n").replace(/^\uFEFF/,"");var l={type:"cbml",nodes:[]},o=l,r=s(e,t),c=[];r.forEach(function(t){switch(t.type){case"single":case"text":o.nodes.push(t),l!==o&&(o.value+=t.value),o.endpos=t.endpos;break;case"left":t.nodes=[],c.push(t),o.nodes.push(t),o=t;break;case"right":var s,r,g,i;if(c.length<=0)throw s=e.slice(0,t.endpos).split("\n"),r=s.length,g=s[s.length-1].length+1,n(s,5),i="No start tag. (line:"+t.line+" col:"+t.col+")",console.error(i),i;for(var p=c.length-1;p>=0;p--){var u=c[p],h=c[p-1];if(u.tag===t.tag&&u.language===t.language&&u.comment===t.comment){if(u.type="block",u.value+=t.value,u.endpos=t.endpos,u.content=a(u.nodes),h?(o=h,o.value+=u.value):o=l,o.endpos=u.endpos,u.nodes&&u.nodes.length){var d=u.nodes[0],f=u.nodes[u.nodes.length-1];u.prefix=u.value.slice(0,d.pos-u.pos),u.suffix=u.value.slice(-(u.endpos-f.endpos))}c=c.slice(0,p);break}if(!h)throw s=e.slice(0,t.endpos).split("\n"),r=s.length,g=s[s.length-1].length+1,n(s,5),i="No start tag. (line:"+t.line+" col:"+t.col+")",console.error(i),i;u.type="text",delete u.nodes,delete u.tag,delete u.attrs,delete u.language,h.value+=u.value,h.endpos=u.endpos}}});for(var g=c.length-1;g>=0;g--){var i=c[g];i.type="text",delete i.nodes,delete i.tag,delete i.attrs,delete i.language;var p=c[g-1];p?p.value+=i.value:p=l,p.endpos=i.endpos}return l}var o=o||{},r={quot:'"',lt:"<",gt:">",amp:"&",nbsp:" "};o.tokenizer=s,o.parse=l,"function"==typeof define?define.amd&&define(function(){return o}):"undefined"!=typeof module&&module.exports?module.exports=o:window[e]=o}("cbml");