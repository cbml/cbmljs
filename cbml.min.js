!function(e){"use strict";function t(e){return String(e).replace(/&((quot|lt|gt|amp|nbsp)|#x([a-f\d]+)|#(\d+));/gi,function(e,t,s,a,n){return s?o[s.toLowerCase()]:String.fromCharCode(a?parseInt(a,16):parseInt(n,10))})}function s(e,s){function a(t,a,o,l){if(!(a>=o)){var c=e.slice(a,o),p={type:t,pos:a,endpos:o,value:c};l=l||{};for(var i in l)p[i]=l[i];if(!s.ignoreLine){var u=e.slice(0,a).split("\n");p.line=u.length,p.col=u[u.length-1].length+1,u=null}r.pos=o,n.push(p)}}s=s||{};for(var n=[],r={text:String(e).replace(/\r\n?|[\n\u2028\u2029]/g,"\n").replace(/^\uFEFF/,""),pos:0};r.pos<r.text.length;){var o=r.text.substring(r.pos).match(/(<!--|\/\*<|\(\*<|'''<)\s*(\/?)([\w_-]+)\s*/);if(!o)break;a("text",r.pos,r.pos+o.index);var l,c,p=o[3],i={},u=o[0].length;switch(o[1]){case"<!--":c=/^\s*(\/?-->)/,l="xml";break;case"/*<":c=/^\s*(\/?>\*\/)/,l="c";break;case"(*<":c=/^\s*(\/?>\*\))/,l="pascal";break;case"'''<":c=/^\s*(\/?>''')/,l="python"}if("/"===o[2]){if(o=r.text.substring(r.pos+u).match(c),!o)throw new Error("parse error.");u+=o[0].length,a("right",r.pos,r.pos+u,{tag:p,language:l})}else{for(;;){if(o=r.text.substring(r.pos+u).match(/^\s*([\w_-]+)\s*/),!o)break;u+=o[0].length;var g=o[1],d="";switch(o=r.text.substring(r.pos+u).match(/^\s*=\s*('([^']*)'|"([^"]*)"|([^'"\s\/>]+))\s*/),o&&(u+=o[0].length,d=o[1]),d[0]){case'"':case"'":d=d.slice(1,-1)}i[g]=t(d)}switch(l){case"xml":c=/^\s*(\/?-->|>)/;break;case"c":c=/^\s*(\/?>\*\/|>)/;break;case"pascal":c=/^\s*(\/?>\*\)|>)/;break;case"python":c=/^\s*(\/?>'''|>)/}if(o=r.text.substring(r.pos+u).match(c),!o)throw new Error("parse error.");u+=o[0].length;var f="";if(">"===o[1]){switch(f+="</"+p,l){case"xml":f+="-->";break;case"c":f+=">*/";break;case"pascal":f+=">*)";break;case"python":f+=">'''"}var h=r.text.substring(r.pos+u).indexOf(f);h>=0&&(u+=h+f.length,a("comment",r.pos,r.pos+u,{tag:p,language:l,attrs:i}))}else a("/"===o[1][0]?"single":"left",r.pos,r.pos+u,{tag:p,language:l,attrs:i})}}return a("text",r.pos,r.text.length),n}function a(e){var t="";return e&&e.forEach(function(e){return t+=e.value}),t}function n(e,t){if(e){var n={type:"cbml",nodes:[]},r=n,o=s(e,t),l=[];o.forEach(function(e){switch(e.type){case"single":case"comment":case"text":r.nodes.push(e),n!==r&&(r.value+=e.value),r.endpos=e.endpos;break;case"left":e.nodes=[],l.push(e),r.nodes.push(e),r=e;break;case"right":for(var t=l.length-1;t>=0;t--){var s=l[t],o=l[t-1];if(s.tag===e.tag&&s.language===e.language){s.type="block",s.value+=e.value,s.endpos=e.endpos,s.content=a(s.nodes),o?(r=o,r.value+=s.value):r=n,r.endpos=s.endpos,l=l.slice(0,t);break}if(!o)throw new Error("parse error.");s.type="text",delete s.nodes,delete s.tag,delete s.attrs,delete s.language,o.value+=s.value,o.endpos=s.endpos}}});for(var c=l.length-1;c>=0;c--){var p=l[c];p.type="text",delete p.nodes,delete p.tag,delete p.attrs,delete p.language;var i=l[c-1];i?i.value+=p.value:i=n,i.endpos=p.endpos}return n}}var r=r||{},o={quot:'"',lt:"<",gt:">",amp:"&",nbsp:" "};r.tokenizer=s,r.parse=n,"function"==typeof define?(define.amd||define.cmd)&&define(function(){return r}):"undefined"!=typeof module&&module.exports?module.exports=r:window[e]=r}("cbml");